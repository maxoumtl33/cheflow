{% extends 'base/base.html' %}
{% load static %}

{% block title %}Vérification - {{ checklist.nom }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .item-card {
        transition: all 0.2s;
        touch-action: manipulation;
    }
    
    .item-card:active {
        transform: scale(0.98);
    }
    
    .item-card.verified {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-color: #10b981 !important;
    }
    
    .check-button {
        transition: all 0.2s;
        touch-action: manipulation;
        min-width: 80px;
        min-height: 80px;
    }
    
    .check-button:active {
        transform: scale(0.95);
    }
    
    .validate-button, .reject-button {
        transition: all 0.2s;
        touch-action: manipulation;
    }
    
    .validate-button:active, .reject-button:active {
        transform: scale(0.95);
    }
    
    .validate-button.active {
        background: #10b981 !important;
        border-color: #10b981 !important;
        color: white !important;
    }
    
    .reject-button.active {
        background: #ef4444 !important;
        border-color: #ef4444 !important;
        color: white !important;
    }
    
    .edit-button {
        min-width: 60px;
        min-height: 60px;
    }
    
    .modal {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    @media (min-width: 768px) and (max-width: 1024px) {
        .item-card { min-height: 100px; }
        .check-button { min-width: 90px; min-height: 90px; }
        .edit-button { min-width: 70px; min-height: 70px; }
    }
    
    @media (min-width: 1024px) and (orientation: landscape) {
        .check-button { min-width: 100px; min-height: 100px; }
    }
    
    .finaliser-btn {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 40;
        max-width: 500px;
        width: calc(100% - 2rem);
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        margin-left: 0.5rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen pb-32">
    
    <!-- Header sticky -->
    <div style="background: white; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="max-width: 1200px; margin: 0 auto; padding: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <a href="{% url 'checklist:dashboard_verificateur' %}" 
                       style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 12px; background: #f1f5f9; text-decoration: none;">
                        <i class="fas fa-arrow-left" style="font-size: 1.5rem; color: #475569;"></i>
                    </a>
                    
                    {% if total_changements > 0 %}
                    <button onclick="openChangementsModal()" 
                            style="position: relative; display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 1.25rem;"></i>
                        <span>Changements</span>
                        <span style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            {{ total_changements }}
                        </span>
                    </button>
                    {% endif %}
                    
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">{{ checklist.nom }}</h1>
                        <p style="font-size: 1rem; color: #6b7280; margin: 0;">#{{ checklist.numero_commande }}</p>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: #3b82f6; line-height: 1;" id="progressPercent">{{ checklist.progression }}%</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        <span id="verifiedCount">{{ items_verifies_count }}</span> / {{ checklist.items.count }} items
                    </div>
                </div>
            </div>
            
            <div style="width: 100%; background: #e2e8f0; border-radius: 9999px; height: 8px; overflow: hidden;">
                <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6, #6366f1); height: 8px; border-radius: 9999px; transition: all 0.5s; width: {{ checklist.progression }}%;"></div>
            </div>
        </div>
    </div>

    <div style="max-width: 1200px; margin: 0 auto; padding: 1.5rem;">
        
        <!-- Résumé -->
        <div style="background: white; border-radius: 20px; border: 1px solid #e5e7eb; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                <div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Date événement</div>
                    <div style="font-weight: 700; color: #1f2937; font-size: 1rem;">
                        <i class="fas fa-calendar" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                        {{ checklist.date_evenement|date:"l j F Y" }}
                    </div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Créée par</div>
                    <div style="font-weight: 700; color: #1f2937; font-size: 1rem;">
                        <i class="fas fa-user" style="color: #6366f1; margin-right: 0.5rem;"></i>
                        {{ checklist.creee_par.get_full_name|default:checklist.creee_par.username }}
                    </div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Statut</div>
                    <span style="display: inline-flex; align-items: center; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600;
                        {% if checklist.status == 'en_attente' %}background: #fef3c7; color: #78350f;
                        {% elif checklist.status == 'en_cours' %}background: #dbeafe; color: #1e40af;
                        {% elif checklist.status == 'validee' %}background: #d1fae5; color: #065f46;
                        {% else %}background: #f1f5f9; color: #475569;{% endif %}">
                        {{ checklist.get_status_display }}
                    </span>
                </div>
            </div>
            
            {% if checklist.notes %}
            <div style="margin-top: 1.5rem; background: #fef3c7; border: 2px solid #fde047; border-radius: 12px; padding: 1rem;">
                <div style="font-size: 0.75rem; font-weight: 700; color: #92400e; margin-bottom: 0.5rem; text-transform: uppercase;">Notes de création</div>
                <p style="font-size: 0.875rem; color: #78350f; margin: 0;">{{ checklist.notes }}</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Items par catégorie -->
        <div style="display: grid; gap: 2rem;">
            {% for cat_nom, data in items_par_categorie.items %}
            <div>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <div style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, #6366f1, #8b5cf6); display: flex; align-items: center; justify-content: center;">
                        <i class="fas {{ data.categorie.icone }}" style="color: white; font-size: 1.75rem;"></i>
                    </div>
                    <div>
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: white; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">{{ cat_nom }}</h2>
                        <p style="font-size: 0.875rem; color: rgba(255,255,255,0.9); margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">{{ data.items|length }} item{{ data.items|length|pluralize }}</p>
                    </div>
                </div>
                
                <div style="display: grid; gap: 1rem;">
                    {% for item in data.items %}
                    <div class="item-card {% if item.statut_verification == 'valide' %}verified{% endif %}" 
                         data-item-id="{{ item.id }}"
                         data-statut="{{ item.statut_verification }}"
                         style="background: white; border-radius: 16px; border: 3px solid #e5e7eb; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 1.5rem;">
                            
                            <!-- Boutons Valider et Refuser -->
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; flex-shrink: 0;">
                                <button onclick="validateItem({{ item.id }})" 
                                        class="validate-button"
                                        data-item-id="{{ item.id }}"
                                        style="width: 80px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 12px; border: 3px solid; cursor: pointer; transition: all 0.2s;
                                               {% if item.statut_verification == 'valide' %}background: #10b981; border-color: #10b981; color: white;{% else %}background: white; border-color: #cbd5e1; color: #cbd5e1;{% endif %}">
                                    <i class="fas fa-check" style="font-size: 1.75rem;"></i>
                                </button>
                                
                                <button onclick="rejectItem({{ item.id }})" 
                                        class="reject-button"
                                        data-item-id="{{ item.id }}"
                                        style="width: 80px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 12px; border: 3px solid; cursor: pointer; transition: all 0.2s;
                                               {% if item.statut_verification == 'refuse' %}background: #ef4444; border-color: #ef4444; color: white;{% else %}background: white; border-color: #ef4444; color: #ef4444;{% endif %}">
                                    <i class="fas fa-times" style="font-size: 1.75rem;"></i>
                                </button>
                            </div>
                            
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: start; justify-content: space-between; gap: 1rem;">
                                    <div style="flex: 1;">
                                        <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin: 0 0 0.5rem 0;">
                                            {{ item.objet.nom }}
                                            
                                            <!-- Badge statut principal -->
                                            {% if item.statut_verification == 'valide' %}
                                            <span class="status-badge" style="background: #d1fae5; color: #065f46;">
                                                <i class="fas fa-check-circle"></i> VALIDÉ
                                            </span>
                                            {% elif item.statut_verification == 'refuse' %}
                                            <span class="status-badge" style="background: #fee2e2; color: #991b1b;">
                                                <i class="fas fa-times-circle"></i> REFUSÉ
                                            </span>
                                            {% elif item.statut_verification == 'en_cours' %}
                                            <span class="status-badge" style="background: #dbeafe; color: #1e40af;">
                                                <i class="fas fa-clock"></i> EN COURS
                                            </span>
                                            {% endif %}
                                            
                                            <!-- Badge modification si applicable -->
                                            {% if item.modifie_depuis_verification %}
                                            <span class="status-badge" style="background: #fef3c7; color: #92400e;">
                                                <i class="fas fa-exclamation-triangle"></i> MODIFIÉ
                                            </span>
                                            {% endif %}
                                        </h3>
                                        <div style="font-size: 1rem; color: #6b7280;">
                                            <span style="font-weight: 600; color: #3b82f6;">
                                                <i class="fas fa-hashtag" style="margin-right: 0.25rem;"></i>{{ item.quantite|floatformat:"-2" }} {{ item.objet.unite }}
                                            </span>
                                        </div>
                                        {% if item.notes %}
                                        <div style="margin-top: 0.75rem; font-size: 0.875rem; color: #92400e; background: #fef3c7; padding: 0.5rem 0.75rem; border-radius: 8px; display: inline-block;">
                                            <i class="fas fa-edit" style="margin-right: 0.25rem;"></i>{{ item.notes }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <button onclick="openEditModal({{ item.id }}, '{{ item.objet.nom|escapejs }}', {{ item.quantite }})" 
                                            class="edit-button"
                                            style="display: flex; align-items: center; justify-content: center; border-radius: 12px; background: #f1f5f9; border: none; cursor: pointer; flex-shrink: 0;">
                                        <i class="fas fa-edit" style="color: #475569; font-size: 1.5rem;"></i>
                                    </button>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        
    </div>
    
</div>

<!-- Bouton Finaliser -->
<div id="finaliserContainer" class="finaliser-btn" style="display: none;">
    <button onclick="openFinalModal()" 
            style="width: 100%; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 16px; font-weight: 700; font-size: 1.25rem; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4); border: none; cursor: pointer;">
        <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
        Finaliser la vérification
    </button>
</div>

<!-- Modal Changements - VERSION AVANCÉE -->
<div id="changementsModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 1rem;">
    <div class="modal" style="background: white; border-radius: 24px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 2rem;">
            <!-- Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                <div>
                    <h3 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">
                        <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-right: 0.5rem;"></i>
                        Changements détectés
                    </h3>
                    <p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0 0 0;">
                        Modifications apportées par les Ventes depuis la dernière vérification
                    </p>
                </div>
                <button onclick="closeChangementsModal()" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; background: #f1f5f9; border: none; cursor: pointer;">
                    <i class="fas fa-times" style="color: #475569; font-size: 1.5rem;"></i>
                </button>
            </div>
            
            <!-- Statistiques -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
    {% if items_ajoutes > 0 %}
    <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 12px; padding: 1rem;">
        <div style="font-size: 0.75rem; color: #1e40af; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">
            <i class="fas fa-plus-circle"></i> Ajoutés
        </div>
        <div style="font-size: 2rem; font-weight: 700; color: #1e40af;">{{ items_ajoutes }}</div>
    </div>
    {% endif %}
    
    {% if items_modifies > 0 %}
    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 1rem;">
        <div style="font-size: 0.75rem; color: #92400e; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">
            <i class="fas fa-edit"></i> Modifiés
        </div>
        <div style="font-size: 2rem; font-weight: 700; color: #92400e;">{{ items_modifies }}</div>
    </div>
    {% endif %}
    
    {% if items_supprimes > 0 %}
    <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 12px; padding: 1rem;">
        <div style="font-size: 0.75rem; color: #991b1b; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">
            <i class="fas fa-trash-alt"></i> Supprimés
        </div>
        <div style="font-size: 2rem; font-weight: 700; color: #991b1b;">{{ items_supprimes }}</div>
    </div>
    {% endif %}
</div>

<!-- Liste des changements -->
<div style="display: grid; gap: 0.75rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
    {% for changement in changements %}
    <div style="background: 
                {% if changement.type == 'ajout' %}#dbeafe
                {% elif changement.type == 'suppression' %}#fee2e2
                {% else %}#fef3c7{% endif %}; 
                border: 2px solid 
                {% if changement.type == 'ajout' %}#3b82f6
                {% elif changement.type == 'suppression' %}#ef4444
                {% else %}#f59e0b{% endif %}; 
                border-radius: 12px; padding: 1rem;">
        <div style="display: flex; align-items: start; gap: 1rem;">
            <!-- Icône -->
            <div style="width: 50px; height: 50px; border-radius: 10px; 
                        background: 
                        {% if changement.type == 'ajout' %}#3b82f6
                        {% elif changement.type == 'suppression' %}#ef4444
                        {% else %}#f59e0b{% endif %}; 
                        display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i class="fas 
                   {% if changement.type == 'ajout' %}fa-plus
                   {% elif changement.type == 'suppression' %}fa-trash-alt
                   {% else %}fa-edit{% endif %}" 
                   style="color: white; font-size: 1.5rem;"></i>
            </div>
            
            <!-- Contenu -->
            <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; flex-wrap: wrap;">
                    <span style="font-weight: 700; color: #1f2937; font-size: 1.125rem;">{{ changement.objet }}</span>
                    <span style="background: 
                                 {% if changement.type == 'ajout' %}#3b82f6
                                 {% elif changement.type == 'suppression' %}#ef4444
                                 {% else %}#f59e0b{% endif %}; 
                                 color: white; padding: 0.125rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">
                        {% if changement.type == 'ajout' %}AJOUTÉ
                        {% elif changement.type == 'suppression' %}SUPPRIMÉ
                        {% else %}MODIFIÉ{% endif %}
                    </span>
                </div>
                
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">
                    <i class="fas fa-tag" style="margin-right: 0.25rem;"></i>{{ changement.categorie }}
                </div>
                
                <!-- Affichage selon le type -->
                {% if changement.type == 'ajout' %}
                    <!-- AJOUT : Flèche verte vers la nouvelle quantité -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="padding: 0.5rem 0.75rem; background: #d1fae5; border-radius: 8px; font-weight: 700; color: #065f46; font-size: 1rem;">
                            <i class="fas fa-arrow-right" style="margin-right: 0.25rem;"></i>
                            {{ changement.quantite|floatformat:"-2" }} {{ changement.unite }}
                        </div>
                    </div>
                    
                {% elif changement.type == 'suppression' %}
                    <!-- SUPPRESSION : Quantité barrée en rouge -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="padding: 0.5rem 0.75rem; background: white; border: 2px dashed #ef4444; border-radius: 8px; font-weight: 700; color: #991b1b; font-size: 1rem;">
                            <i class="fas fa-times" style="margin-right: 0.25rem;"></i>
                            <span style="text-decoration: line-through;">{{ changement.quantite_avant|floatformat:"-2" }} {{ changement.unite }}</span>
                        </div>
                    </div>
                    
                {% else %}
                    <!-- MODIFICATION : Avant → Après avec différence -->
                    {% if changement.difference is not None %}
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                        <!-- Ancienne quantité -->
                        <div style="padding: 0.5rem 0.75rem; background: white; border-radius: 8px; font-size: 0.875rem; color: #6b7280;">
                            <span style="text-decoration: line-through;">{{ changement.quantite_avant|floatformat:"-2" }}</span>
                        </div>
                        
                        <!-- Flèche -->
                        <i class="fas fa-arrow-right" style="color: #6b7280; font-size: 1.25rem;"></i>
                        
                        <!-- Nouvelle quantité -->
                        <div style="padding: 0.5rem 0.75rem; background: white; border: 2px solid #f59e0b; border-radius: 8px; font-weight: 700; color: #92400e; font-size: 1rem;">
                            {{ changement.quantite_apres|floatformat:"-2" }} {{ changement.unite }}
                        </div>
                        
                        <!-- Badge différence -->
                        <div style="padding: 0.5rem 0.75rem; border-radius: 8px; font-size: 0.875rem; font-weight: 700;
                                    {% if changement.difference > 0 %}
                                        background: #d1fae5; color: #065f46; border: 2px solid #10b981;
                                    {% elif changement.difference < 0 %}
                                        background: #fee2e2; color: #991b1b; border: 2px solid #ef4444;
                                    {% else %}
                                        background: #f3f4f6; color: #6b7280;
                                    {% endif %}">
                            {% if changement.difference > 0 %}
                                <i class="fas fa-arrow-up"></i> +{{ changement.difference|floatformat:"-2" }}
                            {% elif changement.difference < 0 %}
                                <i class="fas fa-arrow-down"></i> {{ changement.difference|floatformat:"-2" }}
                            {% else %}
                                =
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <!-- Sans différence (fallback) -->
                    <div style="font-size: 1rem; font-weight: 600; color: #92400e;">
                        Quantité actuelle : {{ changement.quantite_actuelle|floatformat:"-2" }} {{ changement.unite }}
                    </div>
                    {% endif %}
                {% endif %}
                
                <!-- Date et auteur si disponibles -->
                {% if changement.date_modification %}
                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">
                    <i class="fas fa-clock"></i> {{ changement.date_modification|date:"d/m/Y à H:i" }}
                    {% if changement.modifie_par %}
                        par {{ changement.modifie_par.get_full_name|default:changement.modifie_par.username }}
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
            
            <!-- Action -->
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                <button onclick="closeChangementsModal()" 
                        style="width: 100%; padding: 1rem; background: #3b82f6; color: white; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; font-size: 1rem; transition: all 0.3s;">
                    <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
                    Compris, continuer la vérification
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Édition -->
<div id="editModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 1rem;">
    <div class="modal" style="background: white; border-radius: 24px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 2rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">Modifier l'item</h3>
                <button onclick="closeEditModal()" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; background: #f1f5f9; border: none; cursor: pointer;">
                    <i class="fas fa-times" style="color: #475569; font-size: 1.5rem;"></i>
                </button>
            </div>
            
            <form id="editForm" style="display: grid; gap: 1.5rem;">
                <input type="hidden" id="editItemId">
                
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem;">Nom de l'objet</label>
                    <input type="text" id="editNom" 
                           style="width: 100%; padding: 1rem; border: 2px solid #cbd5e1; border-radius: 12px; font-size: 1.125rem;">
                </div>
                
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem;">Quantité</label>
                    <input type="number" id="editQuantite" step="0.01" min="0"
                           style="width: 100%; padding: 1rem; border: 2px solid #cbd5e1; border-radius: 12px; font-size: 1.125rem;">
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="button" onclick="closeEditModal()" 
                            style="flex: 1; padding: 1rem; border: 2px solid #cbd5e1; color: #475569; border-radius: 12px; font-weight: 600; background: white; cursor: pointer;">
                        Annuler
                    </button>
                    <button type="submit" 
                            style="flex: 1; padding: 1rem; background: #3b82f6; color: white; border-radius: 12px; font-weight: 600; border: none; cursor: pointer;">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Finalisation -->
<div id="finalModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 1rem;">
    <div class="modal" style="background: white; border-radius: 24px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 2rem;">
            <h3 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0 0 1.5rem 0;">Finaliser la vérification</h3>
            
            <form method="post" action="{% url 'checklist:finaliser' checklist.id %}">
                {% csrf_token %}
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 1rem;">Statut final</label>
                    <div style="display: grid; gap: 1rem;">
                        <label style="display: flex; align-items: center; padding: 1.25rem; border: 3px solid #86efac; border-radius: 16px; cursor: pointer;">
                            <input type="radio" name="statut" value="validee" style="width: 24px; height: 24px; accent-color: #10b981;" required>
                            <div style="margin-left: 1rem;">
                                <div style="font-weight: 600; color: #1f2937;">Checklist validée</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Tous les items sont conformes</div>
                            </div>
                        </label>
                        
                        <label style="display: flex; align-items: center; padding: 1.25rem; border: 3px solid #fde047; border-radius: 16px; cursor: pointer;">
                            <input type="radio" name="statut" value="incomplete" style="width: 24px; height: 24px; accent-color: #f59e0b;">
                            <div style="margin-left: 1rem;">
                                <div style="font-weight: 600; color: #1f2937;">Checklist incomplète</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Des items manquent ou sont incorrects</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem;">Notes du vérificateur (optionnel)</label>
                    <textarea name="notes_verificateur" rows="4" 
                              style="width: 100%; padding: 1rem; border: 2px solid #cbd5e1; border-radius: 12px; font-size: 1rem;"></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="button" onclick="closeFinalModal()" 
                            style="flex: 1; padding: 1rem; border: 2px solid #cbd5e1; color: #475569; border-radius: 12px; font-weight: 600; background: white; cursor: pointer;">
                        Annuler
                    </button>
                    <button type="submit" 
                            style="flex: 1; padding: 1rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px; font-weight: 600; border: none; cursor: pointer;">
                        Confirmer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let verifiedCount = {{ items_verifies_count }};
const totalItems = {{ checklist.items.count }};

function checkFinalButton() {
    const btn = document.getElementById('finaliserContainer');
    if (verifiedCount === totalItems && totalItems > 0) {
        btn.style.display = 'block';
    } else {
        btn.style.display = 'none';
    }
}

// Valider un item
async function validateItem(itemId) {
    const card = document.querySelector(`[data-item-id="${itemId}"]`);
    const validateBtn = card.querySelector('.validate-button');
    
    if (validateBtn.disabled) return;
    validateBtn.disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('action', 'valider');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        const response = await fetch(`/checklist/item/${itemId}/valider/`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            const rejectBtn = card.querySelector('.reject-button');
            const wasVerified = validateBtn.classList.contains('active');
            
            if (!wasVerified) {
                verifiedCount++;
            }
            
            card.classList.add('verified');
            validateBtn.classList.add('active');
            validateBtn.style.background = '#10b981';
            validateBtn.style.borderColor = '#10b981';
            validateBtn.style.color = 'white';
            
            rejectBtn.classList.remove('active');
            rejectBtn.style.background = 'white';
            rejectBtn.style.borderColor = '#ef4444';
            rejectBtn.style.color = '#ef4444';
            
            updateProgress(data.progression);
            checkFinalButton();
            
            setTimeout(() => {
                location.reload();
            }, 300);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Une erreur est survenue');
    } finally {
        setTimeout(() => {
            validateBtn.disabled = false;
        }, 500);
    }
}

// Refuser un item
async function rejectItem(itemId) {
    const card = document.querySelector(`[data-item-id="${itemId}"]`);
    const rejectBtn = card.querySelector('.reject-button');
    
    if (rejectBtn.disabled) return;
    rejectBtn.disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('action', 'refuser');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        const response = await fetch(`/checklist/item/${itemId}/valider/`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            const validateBtn = card.querySelector('.validate-button');
            const wasVerified = validateBtn.classList.contains('active');
            
            card.classList.remove('verified');
            validateBtn.classList.remove('active');
            validateBtn.style.background = 'white';
            validateBtn.style.borderColor = '#cbd5e1';
            validateBtn.style.color = '#cbd5e1';
            
            rejectBtn.classList.add('active');
            rejectBtn.style.background = '#ef4444';
            rejectBtn.style.borderColor = '#ef4444';
            rejectBtn.style.color = 'white';
            
            if (wasVerified) {
                verifiedCount--;
            }
            
            updateProgress(data.progression);
            checkFinalButton();
            
            setTimeout(() => {
                location.reload();
            }, 300);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Une erreur est survenue');
    } finally {
        setTimeout(() => {
            rejectBtn.disabled = false;
        }, 500);
    }
}

function updateProgress(percentage) {
    document.getElementById('progressPercent').textContent = percentage + '%';
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('verifiedCount').textContent = verifiedCount;
}

function openEditModal(itemId, nom, quantite) {
    document.getElementById('editItemId').value = itemId;
    document.getElementById('editNom').value = nom;
    document.getElementById('editQuantite').value = quantite;
    document.getElementById('editModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const itemId = document.getElementById('editItemId').value;
    const nom = document.getElementById('editNom').value;
    const quantite = document.getElementById('editQuantite').value;
    
    try {
        const formData = new FormData();
        formData.append('nom', nom);
        formData.append('quantite', quantite);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        const response = await fetch(`/checklist/item/${itemId}/modifier/`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Une erreur est survenue');
    }
});

function openFinalModal() {
    document.getElementById('finalModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeFinalModal() {
    document.getElementById('finalModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function openChangementsModal() {
    document.getElementById('changementsModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeChangementsModal() {
    document.getElementById('changementsModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeEditModal();
        closeFinalModal();
        closeChangementsModal();
    }
});

checkFinalButton();
</script>
{% endblock %}