{% extends 'base/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #6366f1;
        --primary-hover: #4f46e5;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --bg-light: #f9fafb;
        --border-color: #e5e7eb;
        --text-dark: #1f2937;
        --text-light: #6b7280;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    .dashboard-container {
        max-width: 1600px;
        margin: 2rem auto;
        padding: 0 1.5rem;
    }

    .header-section {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1.5rem;
    }

    .header-title h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0 0 0.5rem 0;
    }

    .header-subtitle {
        color: var(--text-light);
        font-size: 0.95rem;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.875rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success-color), #059669);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
        background: white;
        color: var(--text-dark);
        border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .tabs-container {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .tabs {
        display: flex;
        gap: 0.5rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .tab {
        padding: 1rem 1.5rem;
        background: transparent;
        border: none;
        font-weight: 600;
        color: var(--text-light);
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        white-space: nowrap;
    }

    .tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    .tab:hover:not(.active) {
        color: var(--text-dark);
    }

    .tab-content {
        display: none;
        padding-top: 2rem;
    }

    .tab-content.active {
        display: block;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .stat-icon.primary {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.2));
        color: var(--primary-color);
    }

    .stat-icon.success {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
        color: var(--success-color);
    }

    .stat-icon.warning {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2));
        color: var(--warning-color);
    }

    .stat-icon.danger {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
        color: var(--danger-color);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: var(--text-light);
        font-size: 0.875rem;
    }

    .content-section {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
        flex-wrap: wrap;
        gap: 1rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
    }

    .search-bar {
        display: flex;
        gap: 1rem;
        flex: 1;
        max-width: 400px;
    }

    .search-input {
        flex: 1;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E") no-repeat 0.75rem center;
        background-size: 18px;
    }

    .search-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        outline: none;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: var(--bg-light);
    }

    .data-table th {
        padding: 1rem;
        text-align: left;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-dark);
    }

    .data-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .data-table tr:hover {
        background: var(--bg-light);
    }

    .badge {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-warning {
        background: #fef3c7;
        color: #78350f;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-primary {
        background: #e0e7ff;
        color: #3730a3;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 8px;
    }

    .btn-edit {
        background: #dbeafe;
        color: #1e40af;
    }

    .btn-edit:hover {
        background: #bfdbfe;
    }

    .btn-delete {
        background: #fee2e2;
        color: #991b1b;
    }

    .btn-delete:hover {
        background: #fecaca;
    }

    .btn-view {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-view:hover {
        background: #e5e7eb;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-light);
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .calendar-container {
        background: transparent;
        padding: 0;
    }

    .calendar-header {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .calendar-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }

    .calendar-nav button {
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .calendar-nav button:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .calendar-month-year {
        font-weight: 700;
        color: var(--text-dark);
        text-align: center;
    }

    .calendar-grid-compact {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.25rem;
    }

    .calendar-day-header-compact {
        text-align: center;
        font-weight: 600;
        color: var(--text-light);
        padding: 0.5rem;
        font-size: 0.75rem;
    }

    .calendar-day-compact {
        aspect-ratio: 1;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.35rem;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: 600;
        min-height: 45px;
    }

    .calendar-day-compact:hover {
        border-color: var(--primary-color);
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    }

    .calendar-day-compact.other-month {
        background: var(--bg-light);
        color: var(--text-light);
        opacity: 0.5;
    }

    .calendar-day-compact.today {
        border-color: var(--primary-color);
        border-width: 2px;
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary-color);
    }

    .calendar-day-compact.has-checklists {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        font-weight: 700;
    }

    .calendar-day-compact.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        border-width: 2px;
    }

    .checklist-count-compact {
        position: absolute;
        top: 2px;
        right: 2px;
        background: var(--success-color);
        color: white;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        font-weight: 700;
    }

    .calendar-day-compact.selected .checklist-count-compact {
        background: white;
        color: var(--primary-color);
    }

    .table-container {
        overflow-x: auto;
    }

    @media (max-width: 1024px) {
        .tabs-container > div > div:first-child {
            grid-template-columns: 1fr !important;
        }

        #noDateSelected,
        #selectedDateDetails {
            grid-column: 1;
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .tabs {
            flex-direction: column;
            border-bottom: none;
        }

        .tab {
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 0;
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
        }

        .data-table {
            font-size: 0.875rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 0.5rem;
        }

        .calendar-day {
            padding: 0.5rem;
            min-height: 60px;
        }

        .day-number {
            font-size: 0.875rem;
        }

        .checklist-count {
            width: 18px;
            height: 18px;
            font-size: 0.65rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="header-section">
        <div class="header-content">
            <div class="header-title">
                <h1>Tableau de bord - Responsable</h1>
                <p class="header-subtitle">Bienvenue, {{ user.get_full_name|default:user.username }}</p>
            </div>
            <div class="header-actions">
                <a href="{% url 'ventes:checklist_create' %}" class="btn btn-primary">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Nouvelle Checklist
                </a>
                <a href="{% url 'livraison:liste_livraisons' %}" class="btn btn-primary">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Livraisons
                </a>
                
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <div>
                    <div class="stat-value">{{ stats.total_checklists }}</div>
                    <div class="stat-label">Checklists totales</div>
                </div>
                <div class="stat-icon primary">📋</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div>
                    <div class="stat-value">{{ stats.total_objets }}</div>
                    <div class="stat-label">Items disponibles</div>
                </div>
                <div class="stat-icon success">📦</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div>
                    <div class="stat-value">{{ stats.total_categories }}</div>
                    <div class="stat-label">Catégories</div>
                </div>
                <div class="stat-icon warning">🏷️</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div>
                    <div class="stat-value">{{ stats.total_vendeuses }}</div>
                    <div class="stat-label">Vendeuses actives</div>
                </div>
                <div class="stat-icon danger">👥</div>
            </div>
        </div>
    </div>

    <!-- Onglets -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('checklists')">Checklists</button>
            <button class="tab" onclick="switchTab('objets')">Items</button>
            <button class="tab" onclick="switchTab('categories')">Catégories</button>
            <button class="tab" onclick="switchTab('vendeuses')">Vendeuses</button>
            <button class="tab" onclick="switchTab('contrats')">Contrats</button>
        </div>

        <!-- Onglet Checklists -->
        <div id="checklists-content" class="tab-content active">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Toutes les checklists</h2>
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Rechercher une checklist..." id="searchChecklists">
                    </div>
                </div>

                {% if checklists %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>N° Commande</th>
                            <th>Date événement</th>
                            <th>Créée par</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="checklistsTable">
                        {% for checklist in checklists %}
                        <tr>
                            <td><strong>{{ checklist.nom }}</strong></td>
                            <td>{{ checklist.numero_commande }}</td>
                            <td>{{ checklist.date_evenement|date:"d/m/Y" }}</td>
                            <td>{{ checklist.creee_par.get_full_name|default:checklist.creee_par.username }}</td>
                            <td>
                                {% if checklist.status == 'validee' %}
                                <span class="badge badge-success">Validée</span>
                                {% elif checklist.status == 'en_cours' %}
                                <span class="badge badge-warning">En cours</span>
                                {% elif checklist.status == 'brouillon' %}
                                <span class="badge badge-primary">Brouillon</span>
                                {% else %}
                                <span class="badge badge-danger">Incomplète</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'ventes:checklist_detail' checklist.pk %}" class="btn btn-view btn-sm">Voir</a>
                                    <a href="{% url 'ventes:checklist_edit' checklist.pk %}" class="btn btn-edit btn-sm">Modifier</a>
                                    <a href="{% url 'ventes:checklist_delete' checklist.pk %}" class="btn btn-delete btn-sm">Supprimer</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <p>Aucune checklist pour le moment</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Onglet Objets -->
        <div id="objets-content" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Gestion des items</h2>
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Rechercher un item..." id="searchObjets">
                    </div>
                    <a href="{% url 'ventes:objet_create' %}" class="btn btn-success btn-sm">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Nouvel item
                    </a>
                </div>

                {% if objets %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Catégorie</th>
                            <th>Unité</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="objetsTable">
                        {% for objet in objets %}
                        <tr>
                            <td><strong>{{ objet.nom }}</strong></td>
                            <td>{{ objet.categorie.nom }}</td>
                            <td>{{ objet.unite }}</td>
                            <td>
                                {% if objet.actif %}
                                <span class="badge badge-success">Actif</span>
                                {% else %}
                                <span class="badge badge-danger">Inactif</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'ventes:objet_edit' objet.pk %}" class="btn btn-edit btn-sm">Modifier</a>
                                    <a href="{% url 'ventes:objet_delete' objet.pk %}" class="btn btn-delete btn-sm">Supprimer</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">📦</div>
                    <p>Aucun item disponible</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Onglet Catégories -->
        <div id="categories-content" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Gestion des catégories</h2>
                    <a href="{% url 'ventes:categorie_create' %}" class="btn btn-success btn-sm">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Nouvelle catégorie
                    </a>
                </div>

                {% if categories %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Icône</th>
                            <th>Nombre d'items</th>
                            <th>Ordre</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for categorie in categories %}
                        <tr>
                            <td><strong>{{ categorie.nom }}</strong></td>
                            <td>{{ categorie.icone|default:"—" }}</td>
                            <td>{{ categorie.objets.count }}</td>
                            <td>{{ categorie.ordre }}</td>
                            <td>
                                {% if categorie.actif %}
                                <span class="badge badge-success">Active</span>
                                {% else %}
                                <span class="badge badge-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'ventes:categorie_edit' categorie.pk %}" class="btn btn-edit btn-sm">Modifier</a>
                                    <a href="{% url 'ventes:categorie_delete' categorie.pk %}" class="btn btn-delete btn-sm">Supprimer</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">🏷️</div>
                    <p>Aucune catégorie disponible</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Onglet Vendeuses -->
        <div id="vendeuses-content" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Gestion des vendeuses</h2>
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Rechercher une vendeuse..." id="searchVendeuses">
                    </div>
                    <a href="{% url 'ventes:vendeuse_create' %}" class="btn btn-success btn-sm">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Nouvelle vendeuse
                    </a>
                </div>

                {% if vendeuses %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nom complet</th>
                            <th>Email</th>
                            <th>Checklists créées</th>
                            <th>Dernière connexion</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendeusesTable">
                        {% for vendeuse in vendeuses %}
                        <tr>
                            <td><strong>{{ vendeuse.get_full_name|default:vendeuse.username }}</strong></td>
                            <td>{{ vendeuse.email }}</td>
                            <td>{{ vendeuse.checklists_creees.count }}</td>
                            <td>{{ vendeuse.last_login|date:"d/m/Y H:i"|default:"Jamais" }}</td>
                            <td>
                                {% if vendeuse.is_active %}
                                <span class="badge badge-success">Active</span>
                                {% else %}
                                <span class="badge badge-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'ventes:vendeuse_edit' vendeuse.pk %}" class="btn btn-edit btn-sm">Modifier</a>
                                    <a href="{% url 'ventes:vendeuse_delete' vendeuse.pk %}" class="btn btn-delete btn-sm">Supprimer</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">👥</div>
                    <p>Aucune vendeuse enregistrée</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Onglet Contrats -->
<div id="contrats-content" class="tab-content">
    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">Gestion des contrats</h2>
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Rechercher un contrat..." id="searchContrats">
            </div>
            <a href="{% url 'ventes:contrat_create_step1' %}" class="btn btn-success btn-sm">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Nouveau contrat
            </a>
        </div>

        {% if contrats %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>N° Contrat</th>
                        <th>Événement</th>
                        <th>Client</th>
                        <th>Date événement</th>
                        <th>Heure</th>
                        <th>Convives</th>
                        <th>Maître d'hôtel</th>
                        <th>Statut</th>
                        <th>Complet</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contratsTable">
                    {% for contrat in contrats %}
                    <tr>
                        <td><strong>{{ contrat.numero_contrat }}</strong></td>
                        <td>{{ contrat.nom_evenement|truncatewords:5 }}</td>
                        <td>
                            {{ contrat.client_nom }}<br>
                            <small style="color: #6b7280;">{{ contrat.client_telephone }}</small>
                        </td>
                        <td>{{ contrat.date_evenement|date:"d/m/Y" }}</td>
                        <td>
                            <small>{{ contrat.heure_debut_prevue|time:"H:i" }} - {{ contrat.heure_fin_prevue|time:"H:i" }}</small>
                        </td>
                        <td>{{ contrat.nb_convives }}</td>
                        <td>
                            {% if contrat.maitre_hotel %}
                                {{ contrat.maitre_hotel.get_full_name|default:contrat.maitre_hotel.username }}
                            {% else %}
                                <span style="color: #6b7280;">Non assigné</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if contrat.status == 'planifie' %}
                            <span class="badge badge-primary">Planifié</span>
                            {% elif contrat.status == 'en_cours' %}
                            <span class="badge badge-warning">En cours</span>
                            {% elif contrat.status == 'termine' %}
                            <span class="badge badge-success">Terminé</span>
                            {% else %}
                            <span class="badge badge-danger">Annulé</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if contrat.est_complet %}
                            <span class="badge badge-success" title="Livraison et Checklist liées">✅ Complet</span>
                            {% else %}
                            <span class="badge badge-warning" title="Livraison ou Checklist manquante">⚠️ Incomplet</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'ventes:contrat_detail' contrat.pk %}" class="btn btn-view btn-sm">Voir</a>
                                <a href="{% url 'ventes:contrat_edit' contrat.pk %}" class="btn btn-edit btn-sm">Modifier</a>
                                <a href="{% url 'ventes:contrat_delete' contrat.pk %}" class="btn btn-delete btn-sm">Supprimer</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">📄</div>
            <p>Aucun contrat enregistré</p>
        </div>
        {% endif %}
    </div>
</div>
    </div>

    <!-- Calendrier des événements -->
    <div class="tabs-container" style="margin-top: 2rem;">
        <h2 class="section-title" style="margin-bottom: 1.5rem;">Calendrier des checklists</h2>
        
        <div style="display: grid; grid-template-columns: 400px 1fr; gap: 2rem; align-items: start;">
            <!-- Calendrier compact à gauche -->
            <div>
                <div class="calendar-header" style="margin-bottom: 1rem; padding-bottom: 1rem;">
                    <div class="calendar-nav">
                        <button id="prevMonth" style="width: 36px; height: 36px;">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <div class="calendar-month-year" id="monthYear" style="font-size: 1.1rem; min-width: 180px;"></div>
                        <button id="nextMonth" style="width: 36px; height: 36px;">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                    <button class="btn btn-secondary" id="todayBtn" style="padding: 0.5rem 1rem; font-size: 0.85rem; margin-top: 0.5rem; width: 100%;">Aujourd'hui</button>
                </div>

                <div class="calendar-grid-compact" id="calendar">
                    <div class="calendar-day-header-compact">L</div>
                    <div class="calendar-day-header-compact">M</div>
                    <div class="calendar-day-header-compact">M</div>
                    <div class="calendar-day-header-compact">J</div>
                    <div class="calendar-day-header-compact">V</div>
                    <div class="calendar-day-header-compact">S</div>
                    <div class="calendar-day-header-compact">D</div>
                </div>
            </div>

            <!-- Détails des checklists à droite -->
            <div id="selectedDateDetails" style="display: none;">
                <h3 style="color: #1f2937; margin-bottom: 1rem; font-size: 1.25rem;" id="selectedDateTitle"></h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>N° Commande</th>
                                <th>Créée par</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="selectedDateTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Message initial -->
            <div id="noDateSelected" style="text-align: center; padding: 3rem; color: var(--text-light);">
                <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">📅</div>
                <p>Cliquez sur une date du calendrier pour voir les checklists</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Données des checklists pour le calendrier
    const checklistsData = {
        {% for date, checklists in checklists_by_date.items %}
        "{{ date }}": [
            {% for checklist in checklists %}
            {
                id: "{{ checklist.pk }}",
                nom: "{{ checklist.nom|escapejs }}",
                numero: "{{ checklist.numero_commande|escapejs }}",
                creePar: "{{ checklist.creee_par.get_full_name|default:checklist.creee_par.username|escapejs }}",
                status: "{{ checklist.status }}",
                statusDisplay: "{{ checklist.get_status_display|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    const today = "{{ today }}";
    let currentDate = new Date();
    let selectedDate = null;

    function switchTab(tabName) {
        // Cacher tous les contenus
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Désactiver tous les onglets
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Activer l'onglet et le contenu sélectionné
        document.getElementById(tabName + '-content').classList.add('active');
        event.target.classList.add('active');
    }

    // Recherche dans les checklists
    document.getElementById('searchChecklists')?.addEventListener('input', function(e) {
        const search = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#checklistsTable tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    });

    // Recherche dans les objets
    document.getElementById('searchObjets')?.addEventListener('input', function(e) {
        const search = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#objetsTable tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    });

    // Recherche dans les vendeuses
    document.getElementById('searchVendeuses')?.addEventListener('input', function(e) {
        const search = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#vendeusesTable tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    });

    // Recherche dans les contrats
    document.getElementById('searchContrats')?.addEventListener('input', function(e) {
        const search = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#contratsTable tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    });

    // Fonctions du calendrier
    document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    document.getElementById('todayBtn').addEventListener('click', () => {
        currentDate = new Date();
        renderCalendar();
    });

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                           'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
        document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        const prevMonthLastDay = new Date(year, month, 0).getDate();

        const calendar = document.getElementById('calendar');
        while (calendar.children.length > 7) {
            calendar.removeChild(calendar.lastChild);
        }

        // Jours du mois précédent
        for (let i = startingDayOfWeek - 1; i >= 0; i--) {
            const day = prevMonthLastDay - i;
            calendar.appendChild(createDayElement(day, true, year, month - 1));
        }

        // Jours du mois actuel
        for (let day = 1; day <= daysInMonth; day++) {
            calendar.appendChild(createDayElement(day, false, year, month));
        }

        // Jours du mois suivant
        const totalCells = calendar.children.length - 7;
        const remainingCells = 42 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
            calendar.appendChild(createDayElement(day, true, year, month + 1));
        }
    }

    function createDayElement(day, isOtherMonth, year, month) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day-compact';
        
        if (isOtherMonth) dayDiv.classList.add('other-month');

        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        if (dateStr === today) dayDiv.classList.add('today');
        if (dateStr === selectedDate) dayDiv.classList.add('selected');

        const checklists = checklistsData[dateStr] || [];
        const hasChecklists = checklists.length > 0;
        
        if (hasChecklists) {
            dayDiv.classList.add('has-checklists');
            dayDiv.innerHTML = `
                ${day}
                <div class="checklist-count-compact">${checklists.length}</div>
            `;
        } else {
            dayDiv.textContent = day;
        }

        dayDiv.addEventListener('click', () => {
            document.querySelectorAll('.calendar-day-compact').forEach(d => d.classList.remove('selected'));
            dayDiv.classList.add('selected');
            selectedDate = dateStr;
            showDateDetails(dateStr, checklists);
        });

        return dayDiv;
    }

    function showDateDetails(dateStr, checklists) {
        const detailsDiv = document.getElementById('selectedDateDetails');
        const noDateDiv = document.getElementById('noDateSelected');
        const titleDiv = document.getElementById('selectedDateTitle');
        const tableBody = document.getElementById('selectedDateTable');

        noDateDiv.style.display = 'none';
        detailsDiv.style.display = 'block';

        const date = new Date(dateStr + 'T00:00:00');
        const formatted = date.toLocaleDateString('fr-FR', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        titleDiv.textContent = `Checklists du ${formatted}`;

        if (checklists.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: #6b7280;">
                        Aucune checklist pour cette date
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = checklists.map(c => {
            const statusBadge = c.status === 'validee' ? '<span class="badge badge-success">Validée</span>' :
                              c.status === 'en_cours' ? '<span class="badge badge-warning">En cours</span>' :
                              c.status === 'brouillon' ? '<span class="badge badge-primary">Brouillon</span>' :
                              '<span class="badge badge-danger">Incomplète</span>';
            
            return `
                <tr>
                    <td><strong>${c.nom}</strong></td>
                    <td>${c.numero}</td>
                    <td>${c.creePar}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="/ventes/checklist/${c.id}/" class="btn btn-view btn-sm">Voir</a>
                            <a href="/ventes/checklist/${c.id}/edit/" class="btn btn-edit btn-sm">Modifier</a>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Initialiser le calendrier
    renderCalendar();
</script>
{% endblock %}