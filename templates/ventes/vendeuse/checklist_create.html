<!-- ==================== ventes/templates/ventes/checklist_create.html ==================== -->
{% extends 'base/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #6366f1;
        --primary-hover: #4f46e5;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --bg-light: #f9fafb;
        --border-color: #e5e7eb;
        --text-dark: #1f2937;
        --text-light: #6b7280;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    .container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 0 1.5rem;
    }

    .card {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #6366f1;
        text-decoration: none;
        font-weight: 600;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }

    .back-btn:hover {
        color: #4f46e5;
        transform: translateX(-3px);
    }

    .stepper {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3rem;
        position: relative;
    }

    .stepper::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 4px;
        background: #e5e7eb;
        z-index: 0;
    }

    .stepper-progress {
        position: absolute;
        top: 20px;
        left: 0;
        height: 4px;
        background: linear-gradient(90deg, #6366f1, #4f46e5);
        z-index: 1;
        transition: width 0.3s ease;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        flex: 1;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 4px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #6b7280;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .step.active .step-number {
        border-color: #6366f1;
        color: #6366f1;
        background: white;
    }

    .step.completed .step-number {
        border-color: #10b981;
        background: #10b981;
        color: white;
    }

    .step-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 600;
        text-align: center;
    }

    .step.active .step-label {
        color: #6366f1;
    }

    .step-content {
        display: none;
    }

    .step-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    h1 {
        font-size: 2rem;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .subtitle {
        color: #6b7280;
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    input:focus,
    textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    input.error {
        border-color: #ef4444;
    }

    textarea {
        resize: vertical;
        min-height: 80px;
    }

    .input-with-prefix {
        position: relative;
    }

    .input-prefix {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        font-weight: 600;
        pointer-events: none;
        font-size: 1rem;
    }

    .input-with-prefix input {
        padding-left: 4.5rem;
    }

    .input-hint {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
        font-weight: 500;
    }

    .error-message.show {
        display: block;
    }

    .search-bar {
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        padding: 1rem 0;
        margin-bottom: 1.5rem;
        border-radius: 12px;
    }

    .search-input-wrapper {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .search-input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        outline: none;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        pointer-events: none;
    }

    .category-section {
        margin-bottom: 2rem;
    }

    .category-section.hidden {
        display: none;
    }

    .category-header {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        font-weight: 700;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .category-header:hover {
        transform: translateX(5px);
    }

    .category-header.collapsed {
        background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        color: #374151;
    }

    .category-toggle-icon {
        transition: transform 0.3s ease;
    }

    .category-header.collapsed .category-toggle-icon {
        transform: rotate(-90deg);
    }

    .objects-container {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 0.5rem;
        display: none;
    }

    .objects-container.show {
        display: block;
    }

    .objects-container::-webkit-scrollbar {
        width: 8px;
    }

    .objects-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .objects-container::-webkit-scrollbar-thumb {
        background: #6366f1;
        border-radius: 10px;
    }

    .object-item {
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
    }

    .object-item.hidden {
        display: none;
    }

    .object-item:hover {
        border-color: #6366f1;
        transform: translateX(5px);
    }

    .object-item.selected {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        border-color: #10b981;
    }

    .object-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .object-name {
        font-weight: 600;
        color: #1f2937;
        flex: 1;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .qty-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 2px solid #6366f1;
        background: white;
        color: #6366f1;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .qty-btn:hover {
        background: #6366f1;
        color: white;
    }

    .qty-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .qty-input {
        width: 50px;
        text-align: center;
        font-weight: 700;
        color: #1f2937;
        font-size: 1rem;
        padding: 0.25rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .qty-input:focus {
        outline: none;
        border-color: #6366f1;
    }

    .btn-add {
        background: #10b981;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-add:hover {
        background: #059669;
        transform: scale(1.05);
    }

    /* Styles pour le bouton commentaire */
    .btn-comment {
        background: #f3f4f6;
        color: #6b7280;
        border: none;
        padding: 0.4rem 0.75rem;
        border-radius: 8px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-weight: 600;
    }

    .btn-comment:hover {
        background: #e5e7eb;
        color: #374151;
    }

    .btn-comment.has-comment {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
    }

    .btn-comment svg {
        width: 14px;
        height: 14px;
    }

    /* Zone de commentaire sous l'objet */
    .comment-preview {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #92400e;
        display: none;
    }

    .comment-preview.show {
        display: block;
    }

    .comment-preview-text {
        margin: 0;
    }

    .selected-items {
        background: #f9fafb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 2rem;
    }

    .selected-items h3 {
        color: #1f2937;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .selected-count {
        background: #6366f1;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
    }

    .selected-item {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid #10b981;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .item-info {
        flex: 1;
    }

    .item-name {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }

    .item-category {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .item-qty {
        background: #e0e7ff;
        color: #6366f1;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 700;
        margin-right: 1rem;
    }

    .item-comment {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #92400e;
    }

    .btn-remove {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-remove:hover {
        background: #dc2626;
    }

    .verification-card {
        background: #f0f9ff;
        border: 2px solid #0ea5e9;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .verification-card h3 {
        color: #0c4a6e;
        margin-bottom: 1rem;
    }

    .info-row {
        display: flex;
        padding: 0.75rem 0;
        border-bottom: 1px solid #bae6fd;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: #0c4a6e;
        width: 180px;
    }

    .info-value {
        color: #0e7490;
        flex: 1;
    }

    .alert-info {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .alert-info p {
        color: #78350f;
        margin: 0;
        font-weight: 500;
    }

    .step-actions {
        display: flex;
        gap: 1rem;
        justify-content: space-between;
        margin-top: 2rem;
    }

    .btn {
        padding: 0.875rem 2rem;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .no-results {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }

    /* Styles du modal commentaire */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
    }

    .btn-close-modal {
        background: #f3f4f6;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .btn-close-modal:hover {
        background: #e5e7eb;
    }

    .modal-object-info {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .comment-textarea {
        width: 100%;
        min-height: 120px;
        padding: 0.875rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        resize: vertical;
        font-family: inherit;
        transition: all 0.3s ease;
    }

    .comment-textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .modal-actions button {
        flex: 1;
        padding: 0.875rem;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.3s ease;
    }

    .btn-modal-cancel {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-modal-cancel:hover {
        background: #e5e7eb;
    }

    .btn-modal-save {
        background: #6366f1;
        color: white;
    }

    .btn-modal-save:hover {
        background: #4f46e5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        {% if request.user.role == 'resp_ventes' %}
            <a href="{% url 'ventes:dashboard_responsable' %}" class="back-btn">
        {% else %}
            <a href="{% url 'ventes:dashboard_vendeuse' %}" class="back-btn">
        {% endif %}
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Retour au dashboard
        </a>

        <h1>‚ú® Cr√©er une nouvelle checklist</h1>
        <p class="subtitle">Processus guid√© en 3 √©tapes</p>

        <!-- Stepper -->
        <div class="stepper">
            <div class="stepper-progress" id="stepperProgress"></div>
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Informations</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Objets</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">V√©rification</div>
            </div>
        </div>

        <form method="post" id="checklistForm" novalidate>
            {% csrf_token %}

            <!-- √âtape 1: Informations de base -->
            <div class="step-content active" data-step="1">
                <h2>üìù Informations de base</h2>
                <p class="subtitle">Commencez par remplir les informations principales</p>

                <div class="form-group">
                    <label for="nom">Nom de la checklist *</label>
                    <input type="text" id="nom" name="nom" required placeholder="Ex: Mariage Dupont">
                    <span class="error-message" id="nom-error">Veuillez entrer un nom pour la checklist</span>
                </div>

                <div class="form-group">
                    <label for="numero_commande">Num√©ro de commande *</label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">CMD-</span>
                        <input 
                            type="text" 
                            id="numero_commande" 
                            name="numero_commande" 
                            required 
                            placeholder="12345"
                            pattern="[0-9]+"
                            title="Veuillez entrer uniquement des chiffres"
                        >
                    </div>
                    <small class="input-hint">
                        Entrez uniquement les chiffres (ex: 12345 devient CMD-12345)
                    </small>
                    <span class="error-message" id="numero_commande-error">Veuillez entrer un num√©ro de commande valide (chiffres uniquement)</span>
                </div>

                <div class="form-group">
                    <label for="date_evenement">Date de l'√©v√©nement *</label>
                    <input type="date" id="date_evenement" name="date_evenement" required>
                    <span class="error-message" id="date_evenement-error">Veuillez s√©lectionner une date pour l'√©v√©nement</span>
                </div>

                <div class="form-group">
                    <label for="notes">Notes (optionnel)</label>
                    <textarea id="notes" name="notes" placeholder="Informations suppl√©mentaires..."></textarea>
                </div>

                <div class="step-actions">
                    <div></div>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                        Suivant
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- √âtape 2: S√©lection des objets -->
            <div class="step-content" data-step="2">
                <h2>üì¶ S√©lection des objets</h2>
                <p class="subtitle">Ajoutez les objets n√©cessaires pour cet √©v√©nement</p>

                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="Rechercher un objet...">
                    </div>
                </div>

                <div id="categoriesContainer">
                    {% for categorie in categories %}
                    <div class="category-section" data-category="{{ categorie.id }}">
                        <div class="category-header collapsed" onclick="toggleCategory(this)">
                            <span>{{ categorie.nom }}</span>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span class="category-count">0 s√©lectionn√©(s)</span>
                                <svg class="category-toggle-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                        </div>
                        <div class="objects-container">
                            {% for objet in categorie.objets.all %}
                            <div class="object-item" data-object-id="{{ objet.id }}" data-object-name="{{ objet.nom }}" data-category-name="{{ categorie.nom }}">
                                <div class="object-item-header">
                                    <div class="object-name">{{ objet.nom }}</div>
                                    <div class="quantity-controls">
                                        <button type="button" class="qty-btn" onclick="decreaseQty(this)">‚àí</button>
                                        <input 
                                            type="number" 
                                            class="qty-input" 
                                            value="1" 
                                            min="1" 
                                            max="9999"
                                            onchange="validateQty(this)"
                                        >
                                        <button type="button" class="qty-btn" onclick="increaseQty(this)">+</button>
                                        <button type="button" class="btn-add" onclick="addItem(this)">Ajouter</button>
                                    </div>
                                </div>
                                
                                <!-- Bouton pour ajouter un commentaire -->
                                <div style="margin-top: 0.5rem;">
                                    <button type="button" 
                                            class="btn-comment" 
                                            onclick="openCommentModal('{{ objet.id }}', '{{ objet.nom|escapejs }}', event)">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                        </svg>
                                        <span class="comment-btn-text">Ajouter un commentaire</span>
                                    </button>
                                </div>
                                
                                <!-- Pr√©visualisation du commentaire -->
                                <div class="comment-preview" data-object-id="{{ objet.id }}">
                                    <p class="comment-preview-text"></p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div id="noResultsMessage" class="no-results" style="display: none;">
                    <div class="empty-state-icon">üîç</div>
                    <p>Aucun objet trouv√© pour cette recherche</p>
                </div>

                <div class="selected-items" id="selectedItemsContainer" style="display: none;">
                    <h3>
                        Objets s√©lectionn√©s
                        <span class="selected-count" id="selectedCount">0</span>
                    </h3>
                    <div id="selectedItemsList"></div>
                </div>

                <div class="step-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        Pr√©c√©dent
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()" id="btnToStep3" disabled>
                        Suivant
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- √âtape 3: V√©rification -->
            <div class="step-content" data-step="3">
                <h2>‚úÖ V√©rification</h2>
                <p class="subtitle">V√©rifiez les informations avant de cr√©er la checklist</p>

                <div class="alert-info">
                    <p>üí° <strong>Bon √† savoir :</strong> Vous pourrez modifier cette checklist √† tout moment depuis le dashboard.</p>
                </div>

                <div class="verification-card">
                    <h3>Informations g√©n√©rales</h3>
                    <div class="info-row">
                        <span class="info-label">Nom :</span>
                        <span class="info-value" id="verify-nom"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Num√©ro de commande :</span>
                        <span class="info-value" id="verify-numero"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Date de l'√©v√©nement :</span>
                        <span class="info-value" id="verify-date"></span>
                    </div>
                    <div class="info-row" id="verify-notes-row" style="display: none;">
                        <span class="info-label">Notes :</span>
                        <span class="info-value" id="verify-notes"></span>
                    </div>
                </div>

                <div class="verification-card">
                    <h3>Objets s√©lectionn√©s (<span id="verify-total-items">0</span>)</h3>
                    <div id="verifyItemsList"></div>
                </div>

                <div class="step-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        Pr√©c√©dent
                    </button>
                    <button type="submit" class="btn btn-success">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Cr√©er la checklist
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal Commentaire -->
<div id="commentModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí¨ Ajouter un commentaire</h3>
            <button type="button" class="btn-close-modal" onclick="closeCommentModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="modal-object-info" id="commentObjectName"></div>
        
        <textarea id="commentTextarea" 
                  class="comment-textarea" 
                  placeholder="Ajoutez un commentaire pour cet objet (ex: dimensions, couleur, quantit√© sp√©ciale...)"></textarea>
        
        <div class="modal-actions">
            <button type="button" class="btn-modal-cancel" onclick="closeCommentModal()">
                Annuler
            </button>
            <button type="button" class="btn-modal-save" onclick="saveComment()">
                Enregistrer
            </button>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;
    const selectedItems = new Map();
    const itemComments = new Map(); // Stocker les commentaires des objets
    let currentCommentObjectId = null;

    // Gestion du champ num√©ro de commande - accepter uniquement les chiffres
    document.getElementById('numero_commande').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        hideError(this);
    });

    // Emp√™cher la saisie de caract√®res non num√©riques
    document.getElementById('numero_commande').addEventListener('keypress', function(e) {
        if (e.which < 48 || e.which > 57) {
            e.preventDefault();
        }
    });

    // Cacher les erreurs quand on tape dans les champs
    document.getElementById('nom').addEventListener('input', function() {
        hideError(this);
    });

    document.getElementById('date_evenement').addEventListener('change', function() {
        hideError(this);
    });

    function showError(input, message) {
        input.classList.add('error');
        const errorElement = document.getElementById(input.id + '-error');
        if (errorElement) {
            if (message) {
                errorElement.textContent = message;
            }
            errorElement.classList.add('show');
        }
    }

    function hideError(input) {
        input.classList.remove('error');
        const errorElement = document.getElementById(input.id + '-error');
        if (errorElement) {
            errorElement.classList.remove('show');
        }
    }

    // ========== GESTION DES COMMENTAIRES ==========
    
    function openCommentModal(objectId, objectName, event) {
        event.stopPropagation();
        event.preventDefault();
        
        currentCommentObjectId = objectId;
        document.getElementById('commentObjectName').textContent = `Pour: ${objectName}`;
        
        // Charger le commentaire existant s'il y en a un
        const existingComment = itemComments.get(objectId) || '';
        document.getElementById('commentTextarea').value = existingComment;
        
        document.getElementById('commentModal').classList.add('show');
        document.body.style.overflow = 'hidden';
        
        // Focus sur le textarea
        setTimeout(() => {
            document.getElementById('commentTextarea').focus();
        }, 100);
    }

    function closeCommentModal() {
        document.getElementById('commentModal').classList.remove('show');
        document.body.style.overflow = 'auto';
        currentCommentObjectId = null;
    }

    function saveComment() {
        if (!currentCommentObjectId) return;
        
        const comment = document.getElementById('commentTextarea').value.trim();
        const objectItem = document.querySelector(`.object-item[data-object-id="${currentCommentObjectId}"]`);
        
        if (comment) {
            // Sauvegarder le commentaire
            itemComments.set(currentCommentObjectId, comment);
            
            // Mettre √† jour le bouton
            const btn = objectItem.querySelector('.btn-comment');
            btn.classList.add('has-comment');
            btn.querySelector('.comment-btn-text').textContent = 'Modifier le commentaire';
            
            // Afficher la pr√©visualisation
            const preview = objectItem.querySelector('.comment-preview');
            preview.querySelector('.comment-preview-text').textContent = comment;
            preview.classList.add('show');
        } else {
            // Supprimer le commentaire
            itemComments.delete(currentCommentObjectId);
            
            // R√©initialiser le bouton
            const btn = objectItem.querySelector('.btn-comment');
            btn.classList.remove('has-comment');
            btn.querySelector('.comment-btn-text').textContent = 'Ajouter un commentaire';
            
            // Cacher la pr√©visualisation
            const preview = objectItem.querySelector('.comment-preview');
            preview.classList.remove('show');
        }
        
        // Mettre √† jour la liste des items s√©lectionn√©s si cet objet est d√©j√† ajout√©
        if (selectedItems.has(currentCommentObjectId)) {
            const item = selectedItems.get(currentCommentObjectId);
            item.comment = comment;
            selectedItems.set(currentCommentObjectId, item);
            updateSelectedItemsList();
        }
        
        closeCommentModal();
    }

    // Fermer le modal avec √âchap
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('commentModal').classList.contains('show')) {
            closeCommentModal();
        }
    });

    // Fermer le modal en cliquant √† l'ext√©rieur
    document.getElementById('commentModal').addEventListener('click', (e) => {
        if (e.target.id === 'commentModal') {
            closeCommentModal();
        }
    });

    // ========== GESTION DES √âTAPES ==========
    
    function updateStepper() {
        document.querySelectorAll('.step').forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');
            
            if (stepNum < currentStep) {
                step.classList.add('completed');
            } else if (stepNum === currentStep) {
                step.classList.add('active');
            }
        });

        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');

        const progress = ((currentStep - 1) / 2) * 100;
        document.getElementById('stepperProgress').style.width = progress + '%';
        // ‚úÖ Faire d√©filer en haut de page avec animation douce
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function nextStep() {
        if (currentStep === 1) {
            if (!validateStep1()) return;
        }
        if (currentStep === 2) {
            if (selectedItems.size === 0) {
                alert('Veuillez ajouter au moins un objet');
                return;
            }
            updateVerification();
        }
        if (currentStep < 3) {
            currentStep++;
            updateStepper();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepper();
        }
    }

    function validateStep1() {
        const nom = document.getElementById('nom');
        const numero = document.getElementById('numero_commande');
        const date = document.getElementById('date_evenement');
        
        let isValid = true;

        if (!nom.value.trim()) {
            showError(nom);
            isValid = false;
        }

        if (!numero.value.trim()) {
            showError(numero);
            isValid = false;
        }

        if (!date.value) {
            showError(date);
            isValid = false;
        }

        if (!isValid) {
            return false;
        }

        if (!numero.value.startsWith('CMD-')) {
            numero.value = 'CMD-' + numero.value;
        }

        return true;
    }

    // Validation de la quantit√©
    function validateQty(input) {
        let value = parseInt(input.value);
        if (isNaN(value) || value < 1) {
            input.value = 1;
        } else if (value > 999) {
            input.value = 999;
        }
    }

    // Gestion des quantit√©s
    function increaseQty(btn) {
        const qtyInput = btn.previousElementSibling;
        let qty = parseInt(qtyInput.value);
        if (qty < 999) {
            qtyInput.value = qty + 1;
        }
    }

    function decreaseQty(btn) {
        const qtyInput = btn.nextElementSibling;
        let qty = parseInt(qtyInput.value);
        if (qty > 1) {
            qtyInput.value = qty - 1;
        }
    }

    // Ajouter un objet
    function addItem(btn) {
        const objectItem = btn.closest('.object-item');
        const objectId = objectItem.dataset.objectId;
        const objectName = objectItem.dataset.objectName;
        const categoryName = objectItem.dataset.categoryName;
        const qtyInput = objectItem.querySelector('.qty-input');
        const qty = parseInt(qtyInput.value);

        if (isNaN(qty) || qty < 1) {
            alert('Veuillez entrer une quantit√© valide');
            return;
        }

        // R√©cup√©rer le commentaire s'il existe
        const comment = itemComments.get(objectId) || '';

        selectedItems.set(objectId, {
            name: objectName,
            quantity: qty,
            category: categoryName,
            comment: comment
        });

        objectItem.classList.add('selected');
        updateSelectedItemsList();
        updateCategoryCount(objectItem.closest('.category-section').dataset.category);
    }

    // Supprimer un objet
    function removeItem(objectId) {
        selectedItems.delete(objectId);
        const objectItem = document.querySelector(`.object-item[data-object-id="${objectId}"]`);
        if (objectItem) {
            objectItem.classList.remove('selected');
            updateCategoryCount(objectItem.closest('.category-section').dataset.category);
        }
        updateSelectedItemsList();
    }

    // Mettre √† jour la liste des objets s√©lectionn√©s
    function updateSelectedItemsList() {
        const container = document.getElementById('selectedItemsContainer');
        const list = document.getElementById('selectedItemsList');
        const count = document.getElementById('selectedCount');
        const btnNext = document.getElementById('btnToStep3');

        if (selectedItems.size === 0) {
            container.style.display = 'none';
            btnNext.disabled = true;
            return;
        }

        container.style.display = 'block';
        btnNext.disabled = false;
        count.textContent = selectedItems.size;

        list.innerHTML = '';
        selectedItems.forEach((item, id) => {
            const div = document.createElement('div');
            div.className = 'selected-item';
            
            let commentHTML = '';
            if (item.comment) {
                commentHTML = `<div class="item-comment">
                    <strong>üí¨ Commentaire :</strong> ${item.comment}
                </div>`;
            }
            
            div.innerHTML = `
                <div class="item-header">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-category">${item.category}</div>
                    </div>
                    <span class="item-qty">Qt√©: ${item.quantity}</span>
                    <button type="button" class="btn-remove" onclick="removeItem('${id}')">Retirer</button>
                </div>
                ${commentHTML}
            `;
            list.appendChild(div);
        });
    }

    // Mettre √† jour le compteur de cat√©gorie
    function updateCategoryCount(categoryId) {
        const category = document.querySelector(`.category-section[data-category="${categoryId}"]`);
        const items = category.querySelectorAll('.object-item.selected');
        const count = category.querySelector('.category-count');
        count.textContent = `${items.length} s√©lectionn√©(s)`;
    }

    // Toggle cat√©gorie
    function toggleCategory(header) {
        const container = header.nextElementSibling;
        const isCollapsed = header.classList.contains('collapsed');
        
        if (isCollapsed) {
            header.classList.remove('collapsed');
            container.classList.add('show');
        } else {
            header.classList.add('collapsed');
            container.classList.remove('show');
        }
    }

    // Recherche am√©lior√©e
    document.getElementById('searchInput')?.addEventListener('input', function(e) {
        const search = e.target.value.toLowerCase().trim();
        const noResultsMsg = document.getElementById('noResultsMessage');
        
        if (search === '') {
            document.querySelectorAll('.category-section').forEach(section => {
                section.classList.remove('hidden');
                const header = section.querySelector('.category-header');
                const container = section.querySelector('.objects-container');
                header.classList.add('collapsed');
                container.classList.remove('show');
                
                section.querySelectorAll('.object-item').forEach(item => {
                    item.classList.remove('hidden');
                });
            });
            noResultsMsg.style.display = 'none';
            return;
        }

        let hasResults = false;

        document.querySelectorAll('.category-section').forEach(section => {
            const objects = section.querySelectorAll('.object-item');
            let categoryHasMatch = false;

            objects.forEach(item => {
                const name = item.dataset.objectName.toLowerCase();
                const match = name.includes(search);
                
                if (match) {
                    item.classList.remove('hidden');
                    categoryHasMatch = true;
                    hasResults = true;
                } else {
                    item.classList.add('hidden');
                }
            });

            const header = section.querySelector('.category-header');
            const container = section.querySelector('.objects-container');
            
            if (categoryHasMatch) {
                section.classList.remove('hidden');
                header.classList.remove('collapsed');
                container.classList.add('show');
            } else {
                section.classList.add('hidden');
            }
        });

        noResultsMsg.style.display = hasResults ? 'none' : 'block';
    });

    // V√©rification finale
    function updateVerification() {
        document.getElementById('verify-nom').textContent = document.getElementById('nom').value;
        
        let numero = document.getElementById('numero_commande').value;
        if (!numero.startsWith('CMD-')) {
            numero = 'CMD-' + numero;
        }
        document.getElementById('verify-numero').textContent = numero;
        
        const dateInput = document.getElementById('date_evenement').value;
        const date = new Date(dateInput);
        const formattedDate = date.toLocaleDateString('fr-FR', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        document.getElementById('verify-date').textContent = formattedDate;

        const notes = document.getElementById('notes').value;
        if (notes) {
            document.getElementById('verify-notes-row').style.display = 'flex';
            document.getElementById('verify-notes').textContent = notes;
        }

        document.getElementById('verify-total-items').textContent = selectedItems.size;

        const verifyList = document.getElementById('verifyItemsList');
        verifyList.innerHTML = '';
        selectedItems.forEach((item, id) => {
            const div = document.createElement('div');
            div.className = 'info-row';
            
            let commentText = '';
            if (item.comment) {
                commentText = `<br><small style="color: #92400e; font-style: italic;">üí¨ ${item.comment}</small>`;
            }
            
            div.innerHTML = `
                <span class="info-label">${item.name}</span>
                <span class="info-value">Quantit√©: ${item.quantity} (${item.category})${commentText}</span>
            `;
            verifyList.appendChild(div);
        });
    }

    // Soumission du formulaire
    document.getElementById('checklistForm').addEventListener('submit', function(e) {
        let numero = document.getElementById('numero_commande').value;
        if (!numero.startsWith('CMD-')) {
            document.getElementById('numero_commande').value = 'CMD-' + numero;
        }

        selectedItems.forEach((item, id) => {
            // Ajouter l'item avec quantit√©
            const inputItem = document.createElement('input');
            inputItem.type = 'hidden';
            inputItem.name = 'items[]';
            inputItem.value = `${id}:${item.quantity}`;
            this.appendChild(inputItem);
            
            // Ajouter le commentaire si pr√©sent
            if (item.comment) {
                const inputComment = document.createElement('input');
                inputComment.type = 'hidden';
                inputComment.name = `comment_${id}`;
                inputComment.value = item.comment;
                this.appendChild(inputComment);
            }
        });
    });

    updateStepper();
</script>
{% endblock %}